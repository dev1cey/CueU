rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ============================
       Helper Functions
    ============================ */

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    /* ============================
       Users
       - players manage their own profile
       - admins manage all
    ============================ */

    match /users/{uid} {
      allow read: if isSignedIn();

      allow create: if isSelf(uid);
      allow update: if isSelf(uid);
      allow delete: if isAdmin();
    }

    /* ============================
       Matches
       - players read
       - admins control writes
    ============================ */

    match /matches/{matchId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /* ============================
       Seasons
    ============================ */

    match /seasons/{seasonId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /* ============================
       News
    ============================ */

    match /news/{newsId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /* ============================
       Events
    ============================ */

    match /events/{eventId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /* ============================
       Notifications
       - players manage their own
       - admins manage all
    ============================ */

    match /notifications/{notificationId} {
      allow read: if isSignedIn();

      allow create: if isAdmin();

      allow update, delete: if isAdmin()
        || (isSignedIn() &&
            request.auth.uid == resource.data.userId);
    }

    /* ============================
       Match Reports
       - players submit
       - admins resolve
    ============================ */

    match /matchReports/{reportId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    /* ============================
       Admin Metadata (optional UI only)
       - NOT source of truth
    ============================ */

    match /admins/{uid} {
      allow read, write: if isAdmin();
    }

  }
}
